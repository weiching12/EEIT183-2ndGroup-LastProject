<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>後台資料管理</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
	<style>
		html,
		body {
			height: 100%;
			min-height: 100%;
		}

		.w250px {
			width: 250px;
		}

		.table thead th {
			background-color: #bcdde8;
			/* color: #ADD8E6; */
		}

		.delete-icon {
			color: rgba(255, 81, 0, 0.753);
		}

		.delete-icon:hover {
			color: red;
		}
	</style>
</head>

<body class="d-flex">
	<nav id="menu" class="bg-secondary-subtle shadow collapse collapse-horizontal">
		<div class="w250px">
			<div class="hstack">
				<button type="button" class="btn-close ms-auto" data-bs-toggle="collapse"
					data-bs-target="#menu"></button>
			</div>

			<div class="d-grid my-1 px-3">
				<button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1"
					aria-expanded="false" aria-controls="collapse1">伴遊功能</button>
				<div class="collapse" id="collapse1">
					<div class="card card-body gap-1 p-1 rounded-0 rounded-bottom">
						<div class="btn btn-secondary btn-sm" id="reviewPfMember">審核伴遊資格</div>
						<div class="btn btn-secondary btn-sm" id="addPfMember">加入伴遊</div>
					</div>
				</div>
			</div>

			<div class="d-grid my-1 px-3">
				<button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse2"
					aria-expanded="false" aria-controls="collapse2">遊戲商城</button>
				<div class="collapse" id="collapse2">
					<div class="card card-body gap-1 p-1 rounded-0 rounded-bottom">
						<div class="btn btn-secondary btn-sm">購物車</div>
					</div>
				</div>
			</div>
			<div class="d-grid my-1 px-3">
				<button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse3"
					aria-expanded="false" aria-controls="collapse3">遊戲道具交易</button>
				<div class="collapse" id="collapse3">
					<div class="card card-body gap-1 p-1 rounded-0 rounded-bottom">
						<div class="btn btn-secondary btn-sm">遊戲道具</div>
						<div class="btn btn-secondary btn-sm">交易綜覽</div>
					</div>
				</div>
			</div>
			<div class="d-grid my-1 px-3">
				<button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse4"
					aria-expanded="false" aria-controls="collapse4">討論區</button>
				<div class="collapse" id="collapse4">
					<div class="card card-body gap-1 p-1 rounded-0 rounded-bottom">
						<div class="btn btn-secondary btn-sm">討論區列表</div>
					</div>
				</div>
			</div>
			<div class="d-grid my-1 px-3">
				<button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse5"
					aria-expanded="false" aria-controls="collapse5">活動辦理</button>
				<div class="collapse" id="collapse5">
					<div class="card card-body gap-1 p-1 rounded-0 rounded-bottom">
						<div class="btn btn-secondary btn-sm">線上活動</div>
						<div class="btn btn-secondary btn-sm">線下活動</div>
					</div>
				</div>
			</div>
		</div>
	</nav>
	<main class="w-100 p-3">
		<button class="btn btn-dark mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#menu"
			aria-expanded="false" aria-controls="menu">
			<i class="fa-sharp fa-solid fa-bars-staggered"></i>
		</button>

		<ul class="nav nav-tabs" id="myTab" role="tablist">
			<li class="nav-item" role="presentation">
				<button class="nav-link text-secondary" id="home-tab" data-bs-toggle="tab"
					data-bs-target="#home-tab-pane" type="button" role="tab" aria-controls="home-tab-pane"
					aria-selected="true">伴遊者列表</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link text-secondary" id="profile-tab" data-bs-toggle="tab"
					data-bs-target="#profile-tab-pane" type="button" role="tab" aria-controls="profile-tab-pane"
					aria-selected="false">交易綜覽</button>
			</li>
		</ul>
		<div class="tab-content" id="myTabContent">
			<div class="tab-pane fade border border-top-0 rounded-2 rounded-top-0" id="home-tab-pane" role="tabpanel"
				aria-labelledby="home-tab" tabindex="0">
				<!-- 這裡放TABLE內容  PlayFellowMember-->
				<br>

				<div class="container">
					<div class="table-container">
						<table id="playFellowTable" class="table table-striped table-bordered table-hover">
							<thead class="thead-light small">
								<tr>
									<th>編號</th>
									<th>伴遊暱稱</th>
									<th>自我描述</th>
									<th>會員編號</th>
									<th>性別</th>
									<th>生日</th>
									<th>創建時間</th>
									<th>狀態</th>
									<th></th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="pfmember : ${PlayFellowMember}" class="small">
									<td th:text="${pfmember.playFellowId}"></td>
									<td th:text="${pfmember.pfnickname}"></td>
									<td><span
											th:text="${pfmember.pfdescription.length() >15 ? pfmember.pfdescription.substring(0, 15) + '...' : pfmember.pfdescription}"></span>
									</td>
									<td th:text="${pfmember.member.memId}"></td>
									<td><span th:if="${pfmember.member.gender == 1}">男生</span>
										<span th:if="${pfmember.member.gender == 2}">女生</span>
									</td>
									<td th:text="${pfmember.member.birthday}"></td>
									<td th:text="${pfmember.pfcreatedTime}"></td>
									<td
										th:text="${pfmember.pfstatus == 1 ? '待審核' : (pfmember.pfstatus == 2 ? '審核成功' : (pfmember.pfstatus == 3 ? '開啟' : '關閉'))}">
										狀態</td>
									<td><a
											th:href="@{/playFellow/updateMember/{playFellowId}(playFellowId=${pfmember.playFellowId})}">
											<i class="fas fa-file-invoice" style="color: rgba(162, 241, 4, 0.704);"></i>
										</a> <i class="fas fa-trash-alt delete-icon"
											th:attr="data-playfellow-id=${pfmember.playFellowId}"></i></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="tab-pane fade border border-top-0 rounded-2 rounded-top-0" id="profile-tab-pane" role="tabpanel"
				aria-labelledby="profile-tab" tabindex="0">
				<!-- 這裡放TABLE內容  PfOrder-->
				<br> <br>
				<div class="container">
					<div class="table-container">
						<table id="orderTable" class="table table-striped table-bordered table-hover">
							<thead class="thead-light small">
								<tr>
									<th>訂單編號</th>
									<th>伴遊暱稱</th>
									<th>下訂會員</th>
									<th>交易序號</th>
									<th>購買數量</th>
									<th>購買金額</th>
									<th>下訂時間</th>
									<th>狀態</th>
								</tr>
							</thead>
							<tbody>
								<!-- 訂單資料 -->
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<!-- 刪除跳窗 -->
		<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="deleteModalLabel">確認刪除</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">確定要刪除這筆資料嗎？</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
						<button type="button" class="btn btn-danger" id="confirmDelete">刪除</button>
					</div>
				</div>
			</div>
		</div>
	</main>

	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		$(document).on('click', '#reviewPfMember', function () {
			window.location.href = '/PlayCentric/playFellow/reviewpfMember';
		})


		$(document).ready(function () {
			$("#home-tab").click();
		});


		function showFullDescription(element, fullDescription) {
			element.innerText = fullDescription;
		}


		document.addEventListener('DOMContentLoaded', (event) => {
			initDeleteEventListeners();
			initModalEventListeners(); // 小視窗監聽
		});

		function initDeleteEventListeners() {
			const deleteIcons = document.querySelectorAll('.delete-icon');
			deleteIcons.forEach(icon => {
				icon.addEventListener('click', () => {
					const playFellowId = icon.dataset.playfellowId;
					showModal(playFellowId);
				});
			});
		}

		function showModal(playFellowId) {
			const modal = new bootstrap.Modal(document.getElementById('deleteModal')); // 跳窗 
			const confirmButton = document.getElementById('confirmDelete'); // 跳窗裡面的再次確定

			confirmButton.dataset.playfellowId = playFellowId;
			modal.show();
		}

		function initModalEventListeners() {
			const confirmButton = document.getElementById('confirmDelete');
			confirmButton.addEventListener('click', async () => {
				const playFellowId = confirmButton.dataset.playfellowId;
				try {
					await axios.delete('/PlayCentric/playFellow/deleteMember/' + playFellowId);
					console.log('刪除成功');
					window.location.reload(); // 刪除成功後重新載入頁面
				} catch (error) {
					console.error('刪除失敗，請洽後台資訊管理', error);
				}
			});
		}

		$(document).ready(function () {
			$('#playFellowTable').DataTable({
				"language": {
					"lengthMenu": "每頁顯示 _MENU_ 筆記錄",
					"zeroRecords": "無符合條件的記錄",
					"info": "顯示第 _PAGE_ 頁，共 _PAGES_ 頁",
					"infoEmpty": "無記錄",
					"infoFiltered": "(從 _MAX_ 筆記錄過濾)",
					"search": "搜尋:",
					"paginate": {
						"first": "首頁",
						"last": "末頁",
						"next": "下一頁",
						"previous": "上一頁"
					}
				}
			});

			$('table tbody tr').click(function () {
				$(this).toggleClass('table-gray');
			});
		});

		document.addEventListener('DOMContentLoaded', function () {
			const addPfMemberBtn = document.querySelector('#addPfMember');

			if (addPfMemberBtn) {
				addPfMemberBtn.addEventListener('click', function () {
					const playFellowId = '10'; // 之後要換上當下的會員身分 替換成實際的伴遊者ID
					const url = `http://localhost:8080/PlayCentric/playFellow/memId/${playFellowId}`;
					window.location.href = url;
				});
			}
		});
	</script>
</body>

</html>